# 1. バックエンドAPI設計

## 1.1. 目次

- [1. バックエンドAPI設計](#1-バックエンドapi設計)
  - [1.1. 目次](#11-目次)
  - [1.2. はじめに](#12-はじめに)
    - [1.2.1. 目的](#121-目的)
    - [1.2.2. 前提](#122-前提)
    - [1.2.3. 凡例](#123-凡例)
  - [1.3. APIエンドポイント一覧](#13-apiエンドポイント一覧)

## 1.2. はじめに

### 1.2.1. 目的

この文書は、「AWSオブザーバビリティ学習用eコマースアプリ」で想定される全てのバックエンドAPIのエンドポイント、主な機能、およびMVPでの実装ステータスを定義します。

### 1.2.2. 前提

- API Gateway (REST API) または Application Load Balancer (ALB) を経由してバックエンド (Lambda, Fargate) にルーティングされます。
- 認証が必要なエンドポイントは Cognito Authorizer やカスタムオーソライザー等によって保護されます。
- レスポンス形式は基本的に JSON とします。
- エラーハンドリングは別途定義しますが、標準的なHTTPステータスコードを使用します。

### 1.2.3. 凡例

- **ステータス:**
  - ✅: MVP (リリース1) で実装
  - ⚪️: MVP以降 (リリース2など) で実装検討
  - ❌: 将来の拡張候補 / MVPでは実装しない

## 1.3. APIエンドポイント一覧

| HTTP Method                    | Path                                 | 担当コンポーネント(例)       | 認証                   | 説明                                                  | Request Body (主要)                                                                    | Response Body (主要)                                                           | ステータス |
| :----------------------------- | :----------------------------------- | :--------------------------- | :--------------------- | :---------------------------------------------------- | :------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------- | :--------: |
| **商品関連 (顧客向け)**        |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/products`                          | Lambda_Product               | 不要                   | 商品一覧を取得 (フィルタ、ページネーション対応)       | Query: `category`, `keyword`, `page`, `limit`                                          | `{items: [{id, name, price, image_url}], totalPages, currentPage}`             |     ✅      |
| GET                            | `/products/{productId}`              | Lambda_Product               | 不要                   | 特定の商品詳細を取得 (在庫、レビュー概要含む)         | -                                                                                      | `{id, name, description, price, stock_quantity, image_url, avg_rating?}`       |     ✅      |
| GET                            | `/products/{productId}/related`      | Lambda_Product               | 不要                   | 関連商品リストを取得                                  | -                                                                                      | `[{id, name, price, image_url}]`                                               |     ❌      |
| GET                            | `/products/{productId}/reviews`      | Lambda_Review                | 不要                   | 商品レビュー一覧を取得 (ページネーション対応)         | Query: `page`, `limit`                                                                 | `{items: [{rating, comment, customer_name, created_at}], ...}`                 |     ❌      |
| POST                           | `/products/{productId}/notify`       | Lambda_Notify                | 要 (顧客)              | 在庫切れ商品の入荷通知を登録                          | `{email}` (ゲスト時) or uses logged-in user email                                      | `{status: "registered"}`                                                       |     ⚪️      |
| **カート関連 (顧客向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| POST                           | `/cart/items`                        | Lambda_Cart/Fargate_Cart     | 不要 (セッション/顧客) | カートに商品を追加                                    | `{productId, quantity}`                                                                | `{cart_items, subtotal, total_amount}`                                         |     ✅      |
| GET                            | `/cart`                              | Lambda_Cart/Fargate_Cart     | 不要 (セッション/顧客) | 現在のカート内容を取得                                | -                                                                                      | `{cart_items, subtotal, total_amount}`                                         |     ✅      |
| PUT                            | `/cart/items/{itemId}`               | Lambda_Cart/Fargate_Cart     | 不要 (セッション/顧客) | カート内商品の数量を変更                              | `{quantity}`                                                                           | `{cart_items, subtotal, total_amount}`                                         |     ⚪️      |
| DELETE                         | `/cart/items/{itemId}`               | Lambda_Cart/Fargate_Cart     | 不要 (セッション/顧客) | カートから特定商品を削除                              | -                                                                                      | `{cart_items, subtotal, total_amount}`                                         |     ⚪️      |
| **注文関連 (顧客向け)**        |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| POST                           | `/orders`                            | Lambda_Order                 | 不要/要(顧客)          | 注文を作成 (ゲストまたはログイン顧客)                 | `{guest_email?, shipping_address, items: [{...}], payment_method?, coupon_code?}`      | `{orderId, status, total_amount}`                                              |     ✅      |
| POST                           | `/orders/apply-coupon`               | Lambda_Order                 | 不要/要(顧客)          | (注文前または注文時に) クーポンコードを検証・適用     | `{coupon_code, current_items}`                                                         | `{discount_amount, new_total}`                                                 |     ❌      |
| GET                            | `/orders/{orderId}`                  | Lambda_Order                 | 要 (顧客/Admin)        | 特定の注文詳細を取得 (顧客/管理者用)                  | -                                                                                      | `{id, status, total_amount, items: [...], shipping_address, tracking_number?}` |     ⚪️      |
| **アカウント/認証 (顧客向け)** |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| POST                           | `/auth/register`                     | Cognito (via Lambda)         | 不要                   | 顧客アカウント登録                                    | `{email, password, name}`                                                              | `{user_id}`                                                                    |     ⚪️      |
| POST                           | `/auth/login`                        | Cognito                      | 不要                   | 顧客ログイン (Email/PW or Social)                     | `{email, password}` or `{provider, token}`                                             | `{access_token, refresh_token, id_token}`                                      |     ⚪️      |
| POST                           | `/auth/forgot-password`              | Cognito                      | 不要                   | パスワードリセット要求                                | `{email}`                                                                              | `{status: "reset_code_sent"}`                                                  |     ⚪️      |
| POST                           | `/auth/reset-password`               | Cognito                      | 不要                   | 新パスワード設定                                      | `{email, reset_code, new_password}`                                                    | `{status: "password_reset"}`                                                   |     ⚪️      |
| GET                            | `/account/profile`                   | Lambda_Account               | 要 (顧客)              | 顧客プロフィール取得                                  | -                                                                                      | `{email, name, default_shipping_address}`                                      |     ❌      |
| PUT                            | `/account/profile`                   | Lambda_Account               | 要 (顧客)              | 顧客プロフィール更新                                  | `{name?, default_shipping_address?}`                                                   | `{email, name, default_shipping_address}`                                      |     ❌      |
| GET                            | `/account/orders`                    | Lambda_Order                 | 要 (顧客)              | ログイン顧客の注文履歴一覧                            | Query: `page`, `limit`                                                                 | `{items: [{id, created_at, total_amount, status}], ...}`                       |     ❌      |
| **認証関連 (管理者向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| POST                           | `/admin/auth/login`                  | Cognito                      | 不要                   | 管理者としてログイン                                  | `{email, password}`                                                                    | `{access_token, refresh_token, id_token}`                                      |     ✅      |
| **商品管理 (管理者向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/products`                    | Lambda_Product               | 要 (Admin)             | 商品一覧を取得 (管理用)                               | Query: `category`, `keyword`, `status`, `page`, `limit`                                | `{items: [{...}], totalPages, currentPage}`                                    |     ✅      |
| POST                           | `/admin/products`                    | Lambda_Product               | 要 (Admin)             | 新規商品を登録                                        | `{name, description, price, stock_quantity, category_id, image_url?, is_active?}`      | `{id}`                                                                         |     ✅      |
| PUT                            | `/admin/products/{productId}`        | Lambda_Product               | 要 (Admin)             | 商品情報を更新                                        | `{name?, description?, price?, stock_quantity?, category_id?, image_url?, is_active?}` | `{id}`                                                                         |     ✅      |
| DELETE                         | `/admin/products/{productId}`        | Lambda_Product               | 要 (Admin)             | 商品を削除 (論理削除 or 物理削除)                     | -                                                                                      | `{status: "deleted"}`                                                          |     ❌      |
| PUT                            | `/admin/products/{productId}/status` | Lambda_Product               | 要 (Admin)             | 商品の有効/無効状態を更新                             | `{is_active}`                                                                          | `{id}`                                                                         |     ✅      |
| **カテゴリ管理 (管理者向け)**  |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/categories`                  | Lambda_Product               | 要 (Admin)             | カテゴリ一覧を取得                                    | -                                                                                      | `[{id, name}]`                                                                 |     ✅      |
| POST                           | `/admin/categories`                  | Lambda_Product               | 要 (Admin)             | 新規カテゴリを登録                                    | `{name}`                                                                               | `{id}`                                                                         |     ✅      |
| PUT                            | `/admin/categories/{categoryId}`     | Lambda_Product               | 要 (Admin)             | カテゴリ情報を更新                                    | `{name}`                                                                               | `{id}`                                                                         |     ❌      |
| DELETE                         | `/admin/categories/{categoryId}`     | Lambda_Product               | 要 (Admin)             | カテゴリを削除                                        | -                                                                                      | `{status: "deleted"}`                                                          |     ❌      |
| **在庫管理 (管理者向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/inventory`                   | Lambda_Product/Fargate_Stock | 要 (Admin)             | 在庫一覧を取得                                        | Query: `low_stock_threshold`?                                                          | `[{productId, name, stock_quantity}]`                                          |     ✅      |
| POST                           | `/admin/inventory/alerts`            | Lambda_Setting               | 要 (Admin)             | 低在庫アラート閾値を設定                              | `{productId, threshold}`                                                               | `{status: "ok"}`                                                               |     ⚪️      |
| **注文管理 (管理者向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/orders`                      | Lambda_Order                 | 要 (Admin)             | 注文一覧を取得                                        | Query: `status`, `date_from`, `date_to`, `page`, `limit`                               | `{items: [{...}], ...}`                                                        |     ✅      |
| GET                            | `/admin/orders/{orderId}`            | Lambda_Order                 | 要 (Admin)             | 特定の注文詳細を取得                                  | -                                                                                      | `{id, ..., items: [...]}`                                                      |     ✅      |
| PUT                            | `/admin/orders/{orderId}/status`     | Lambda_Order                 | 要 (Admin)             | 注文ステータスを更新                                  | `{status}`                                                                             | `{id, status}`                                                                 |     ⚪️      |
| POST                           | `/admin/orders/{orderId}/shipment`   | Lambda_Order                 | 要 (Admin)             | 出荷情報を登録                                        | `{tracking_number, carrier}`                                                           | `{id, status}`                                                                 |     ⚪️      |
| GET                            | `/admin/returns`                     | Lambda_Order                 | 要 (Admin)             | 返品・交換リクエスト一覧                              | Query: `status`                                                                        | `[{returnId, orderId, customer, status, ...}]`                                 |     ❌      |
| PUT                            | `/admin/returns/{returnId}/status`   | Lambda_Order                 | 要 (Admin)             | 返品・交換リクエストのステータス更新 (承認/却下/完了) | `{status, reason?}`                                                                    | `{returnId, status}`                                                           |     ❌      |
| **レポート (管理者向け)**      |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/reports/sales-summary`       | Lambda_Report                | 要 (Admin)             | 基本的な売上概要レポート                              | Query: `period` (day, week, month)                                                     | `{total_sales, order_count, average_order_value}`                              |     ⚪️      |
| **マーケティング(管理者向け)** |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/promotions`                  | Lambda_Promo                 | 要 (Admin)             | プロモーション一覧                                    | -                                                                                      | `[{id, code, type, value, start_date, end_date, is_active}]`                   |     ❌      |
| POST                           | `/admin/promotions`                  | Lambda_Promo                 | 要 (Admin)             | 新規プロモーション作成                                | `{code, description, type, value, start_date, end_date, is_active}`                    | `{id}`                                                                         |     ❌      |
| PUT                            | `/admin/promotions/{promoId}`        | Lambda_Promo                 | 要 (Admin)             | プロモーション更新                                    | `{...}`                                                                                | `{id}`                                                                         |     ❌      |
| **ユーザー管理 (管理者向け)**  |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/users`                       | Cognito (via Lambda)         | 要 (Admin)             | 管理者ユーザー一覧を取得                              | -                                                                                      | `[{id, email, role, status}]`                                                  |     ✅      |
| POST                           | `/admin/users`                       | Cognito (via Lambda)         | 要 (Admin)             | 新規管理者ユーザーを作成                              | `{email, initial_password, role}`                                                      | `{id}`                                                                         |     ✅      |
| PUT                            | `/admin/users/{userId}`              | Cognito (via Lambda)         | 要 (Admin)             | 管理者ユーザー情報更新 (ロール、ステータス等)         | `{role?, status?}`                                                                     | `{id}`                                                                         |     ✅      |
| DELETE                         | `/admin/users/{userId}`              | Cognito (via Lambda)         | 要 (Admin)             | 管理者ユーザーを削除                                  | -                                                                                      | `{status: "deleted"}`                                                          |     ⚪️      |
| **ロール管理 (管理者向け)**    |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/roles`                       | Cognito (Groups via Lambda)  | 要 (Admin)             | ロール一覧を取得                                      | -                                                                                      | `[{name, description?}]`                                                       |     ✅      |
| POST                           | `/admin/roles`                       | Cognito (Groups via Lambda)  | 要 (Admin)             | 新規ロールを作成                                      | `{name, description?}`                                                                 | `{name}`                                                                       |     ✅      |
| PUT                            | `/admin/roles/{roleName}`            | Cognito/IAM (via Lambda)     | 要 (Admin)             | ロールの権限を更新                                    | `{permissions}` (具体的な権限定義による)                                               | `{name}`                                                                       |     ✅      |
| DELETE                         | `/admin/roles/{roleName}`            | Cognito (Groups via Lambda)  | 要 (Admin)             | ロールを削除                                          | -                                                                                      | `{status: "deleted"}`                                                          |     ⚪️      |
| **認証ポリシー (管理者向け)**  |                                      |                              |                        |                                                       |                                                                                        |                                                                                |            |
| GET                            | `/admin/auth/policy`                 | Cognito (via Lambda)         | 要 (Admin)             | 現在の認証ポリシー設定を取得                          | -                                                                                      | `{mfa_config, password_policy, session_policy}`                                |     ⚪️      |
| PUT                            | `/admin/auth/policy`                 | Cognito (via Lambda)         | 要 (Admin)             | 認証ポリシー設定を更新                                | `{mfa_config?, password_policy?, session_policy?}`                                     | `{status: "updated"}`                                                          |     ⚪️      |

**注記:**

- **担当コンポーネント:** あくまで一例です。実際の設計では、機能の複雑さや関心事に応じて Lambda 関数を分割したり、Fargate サービスの役割を変えたりすることがあります。
- **認証:** `不要 (セッション/顧客)` は、カートのようにログイン状態に応じて挙動が変わる可能性があることを示します。MVPではゲストのみです。`要 (Admin)` は管理者権限が必要です。
- **RequestBody / Response Body:** 主要な項目のみ記載しています。エラーレスポンス、ページネーション情報、共通フィールド（`created_at`等）は省略しています。
- **カートAPI:** MVPではカートデータを永続化しない場合、これらのAPIはクライアントサイドで完結するか、非常にシンプルなサーバーサイド実装（インメモリやキャッシュ利用）になる可能性があります。
- **権限管理:** `/admin/roles/{roleName}` の権限更新(PUT)は、具体的な権限モデル（API Gatewayのカスタムオーソライザーか、アプリケーションレベルの認可かなど）によって実装が大きく変わります。MVPでは基本的なロール作成・割り当てに留める可能性が高いです。
