# 1. 環境定義

## 1.1. 目次

- [1. 環境定義](#1-環境定義)
  - [1.1. 目次](#11-目次)
  - [1.2. はじめに](#12-はじめに)
    - [1.2.1. 目的](#121-目的)
    - [1.2.2. 対象範囲](#122-対象範囲)
  - [1.3. 環境一覧と目的](#13-環境一覧と目的)
  - [1.4. 環境分離戦略](#14-環境分離戦略)
  - [1.5. インフラストラクチャ管理 (IaC - Terraform)](#15-インフラストラクチャ管理-iac---terraform)
  - [1.6. アプリケーションデプロイ (CI/CD - GitHub Actions)](#16-アプリケーションデプロイ-cicd---github-actions)
  - [1.7. 設定管理](#17-設定管理)
  - [1.8. データ管理](#18-データ管理)
  - [1.9. オブザーバビリティ設定](#19-オブザーバビリティ設定)
  - [1.10. アクセス制御 (IAM)](#110-アクセス制御-iam)
  - [1.11. ローカル開発環境との連携](#111-ローカル開発環境との連携)
  - [1.12. コスト管理方針](#112-コスト管理方針)

## 1.2. はじめに

### 1.2.1. 目的

この文書は、「AWSオブザーバビリティ学習用eコマースアプリ」プロジェクトにおける各環境（ローカル、開発、ステージング、本番(学習用)）の構成、目的、管理方針を定義します。一貫性のある環境管理により、効率的な開発、テスト、および学習体験の提供を目指します。

### 1.2.2. 対象範囲

本文書は、アプリケーション開発からデプロイ、運用（学習活動）に関わる全ての環境を対象とします。

## 1.3. 環境一覧と目的

本プロジェクトでは、以下の環境を定義し、利用します。

| 環境名            | 略称 | 主な目的                                                                    | 利用者                  | インフラ構築               | デプロイ頻度    | データ永続性  |
| :---------------- | :--- | :-------------------------------------------------------------------------- | :---------------------- | :------------------------- | :-------------- | :------------ |
| **ローカル開発**  | LOC  | 個々の開発者による機能実装、単体テスト、デバッグ                            | 開発者                  | Docker Compose, LocalStack | 随時            | 低 (一時的)   |
| **開発**          | DEV  | CIによる自動ビルド・デプロイ、開発ブランチの統合テスト、機能確認            | 開発者, CI/CD           | Terraform                  | 高 (Push毎)     | 中 (定期削除) |
| **ステージング**  | STG  | 本番環境に近い状態での結合テスト、パフォーマンステスト、UAT、リリース前検証 | 開発者, SRE, (テスター) | Terraform                  | 中 (手動/Tag毎) | 高 (維持)     |
| **本番 (学習用)** | PRD  | 学習者が実際に操作し、オブザーバビリティツールを体験する安定稼働環境        | 学習参加者全員, SRE     | Terraform                  | 低 (計画的)     | 高 (維持)     |

## 1.4. 環境分離戦略

各環境は互いに影響を与えないように分離します。

* **AWSアカウント:** 可能であれば、**DEV/STG** と **PRD** でAWSアカウントを分離することを推奨します。これが難しい場合は、単一アカウント内でIAMポリシーとリソース命名規則により論理的に分離します。
* **VPC:** 各環境（DEV, STG, PRD）は独立したVPC内に構築します。
* **リソース命名規則:** 全てのAWSリソース名に環境を示すプレフィックス（例: `obs-dev-`, `obs-stg-`, `obs-prd-`）を付与し、識別と権限管理を容易にします。

## 1.5. インフラストラクチャ管理 (IaC - Terraform)

* **ツール:** Terraform を使用し、AWSインフラストラクチャをコードで管理します。
* **構成管理:** Terraform Workspace を利用して、単一のコードベースから各環境（DEV, STG, PRD）のインフラを管理します。環境ごとの差異（インスタンスサイズ、スケーリング設定など）は、Workspaceに応じた `tfvars` ファイルで管理します。
* **ローカル連携:** ローカル開発環境では `tflocal` ラッパーを使用し、TerraformコードをLocalStackに対して適用できるようにします。
* **適用プロセス:**
  * DEV: 開発ブランチへのマージ時にCI/CDパイプラインから自動的に `terraform apply` を実行します。
  * STG/PRD: リリースブランチやタグから、手動承認を経て `terraform apply` を実行します。

## 1.6. アプリケーションデプロイ (CI/CD - GitHub Actions)

* **ツール:** GitHub Actions を使用してCI/CDパイプラインを構築します。
* **ブランチ戦略:** Git Flow または GitHub Flow を採用します。
  * `main` (or `master`): PRD環境に対応。
  * `develop`: DEV環境に対応。リリース準備ブランチの起点。
  * `feature/*`: 機能開発ブランチ。
  * `release/*`: STG環境でのテスト、PRDリリース準備ブランチ。
* **デプロイフロー:**
  * `feature/*` → `develop`: Pull Request マージ時に自動テスト実行。マージ後、DEV環境へ自動デプロイ。
  * `develop` → `release/*`: リリース準備開始時にブランチ作成。STG環境へ手動トリガー（または自動）でデプロイ。
  * `release/*` → `main`: STGでの検証後、Pull Request マージ。マージ後、PRD環境へ手動承認を経てデプロイ。同時に `develop` にもマージ。
* **環境ごとの設定:** デプロイ時に、各環境用の設定値（後述）を参照してコンテナイメージやLambda関数パッケージを作成・設定します。

## 1.7. 設定管理

環境ごとに異なる設定値（APIキー、DB接続情報、リソース名など）は、以下の方法で管理します。

* **AWS Systems Manager Parameter Store:** 一般的な設定値（非機密情報）を格納します。パラメータ名は環境プレフィックスを含めます（例: `/obs/dev/db/host`）。
* **AWS Secrets Manager:** DBパスワードや外部APIキーなどの機密情報を格納します。
* **環境変数:** コンテナやLambda関数には、Parameter StoreやSecrets Managerから取得した値を環境変数として渡します。IaC (Terraform) や CI/CD スクリプトでこれらの注入を管理します。

## 1.8. データ管理

* **スキーマ管理:** `golang-migrate` を使用し、DBスキーマのバージョン管理とマイグレーションを行います。CI/CDパイプラインで各環境へのマイグレーションを実行します。
* **テストデータ:**
  * LOC/DEV: 開発や自動テストに必要な最小限のテストデータを、マイグレーション後などにスクリプトで投入します。
  * STG: より現実に近いテストデータを用意し、手動またはスクリプトで投入します。
  * PRD: 学習者が操作することでデータが蓄積されます。初期データが必要な場合は最小限投入します。
* **データマスキング:** 本プロジェクトは学習用であり、個人情報などを扱わない前提のため、厳密なマスキングは必須としません。ただし、扱うデータには注意を払います。

## 1.9. オブザーバビリティ設定

各環境でオブザーバビリティ設定を調整し、学習効果とコストのバランスを取ります。

* **ログレベル:**
  * LOC/DEV: DEBUGレベルを有効にし、詳細なトレースや内部状態を確認できるようにします。
  * STG: INFOレベルを基本とし、必要に応じてデバッグログを有効化できるようにします。
  * PRD: INFOレベルを基本とします。
* **ロググループ:** 環境ごとにロググループ名を分けます (例: `/aws/lambda/obs-dev-OrderFunction`)。保持期間も環境に応じて設定します (DEVは短く、PRDは長くなど)。
* **トレース (X-Ray):**
  * サンプリングレートを環境ごとに調整します (DEV/STGは高め、PRDは低めだが重要なパスはカバー)。
* **メトリクス/ダッシュボード/アラーム:**
  * 基本的な監視項目は全環境で設定しますが、アラートの閾値や通知先は環境ごとに調整します。PRD環境のアラートはSRE（学習者含む）が確実に受け取れるようにします。
* **データ分離:** CloudWatch Logs/Metrics/X-Rayのデータは、リソース命名規則とアカウント分離（可能な場合）により、環境ごとに分離されます。

## 1.10. アクセス制御 (IAM)

* **最小権限の原則:** 各環境へのアクセス権限は、IAMユーザー/ロールを用いて最小限にします。
* **ロールベースアクセス:** 開発者、SRE、学習参加者などのロールに応じたIAMポリシーを作成し、管理します。
* **環境ごとの権限:** PRD環境への変更権限は厳格に管理します。

## 1.11. ローカル開発環境との連携

* ローカル環境 (LOC) は、Docker Compose と LocalStack を使用して構築します。
* `awslocal` や `tflocal` を使用することで、クラウド環境と同じツール (AWS CLI, Terraform) を使ってローカルの擬似AWS環境を操作でき、一貫性のある開発体験を提供します。
* ローカルでのオブザーバビリティ確認には、LocalStackの機能や、ローカルで動作するJaeger UIなどを連携させることも検討します。

## 1.12. コスト管理方針

* 学習用プロジェクトであるため、過度なコスト最適化は必須ではありませんが、コスト意識を持つことは重要です。
* DEV/STG環境は、利用しない時間帯（夜間・休日）の停止を検討します（自動化スクリプトなど）。
* PRD環境は学習時間中は基本的に稼働させますが、リソースサイジングは過剰にならないように注意します。
* オブザーバビリティ関連のコスト（ログ保存期間、メトリクス数、トレースサンプリングレート）は、学習効果とコストのバランスを考慮して設定します。定期的にCost Explorerでコストを確認します。
