# 1. AWSオブザーバビリティ学習用eコマースアプリ改善実装計画

## 1.1. プロジェクト概要

このeコマースアプリケーションは、AWSオブザーバビリティパターンの学習を目的としたMVP(Minimum Viable Product)アプリケーションです。オブザーバビリティの2つのアプローチ（AWS SDK v2とOpenTelemetry）を実装・比較することで、それぞれの特性や使い方を学びます。

### 1.1.1. 概要

オブザーバビリティとは、システムの内部状態を外部からの観測によって理解する能力です。以下の「3本の柱」から構成されています：

1. **ログ（Logs）**：システムで何が起きたかの記録
2. **メトリクス（Metrics）**：システムの状態を数値で表現したもの
3. **トレース（Traces）**：リクエストがシステム内をどのように流れるかの追跡

### 1.1.2. プロジェクトの目的

1. Go言語とNext.jsによるフルスタックeコマースアプリケーションの開発
2. AWS環境でのアプリケーション運用とオブザーバビリティの実装
3. AWS SDK v2とOpenTelemetryの2つのアプローチによるオブザーバビリティの比較と学習

### 1.1.3. 技術スタック

**フロントエンド:**

- Next.js (Reactベースのフレームワーク)
- TypeScript
- TailwindCSS
- AWS S3 + CloudFront (静的アセットホスティング)

**バックエンド:**

- Go言語 (Echo Webフレームワーク)
- sqlboiler (MySQLに特化したORM)
- OpenAPI (ogen でのコード生成)
- slog (構造化ログ)
- AWS Fargate (ECS)
- AWS Lambda (サーバーレス機能)
- MySQL (RDS)
- AWS ALB (Application Load Balancer)

**オブザーバビリティ:**

1. AWS SDK v2アプローチ
   - X-Ray SDK for Go v2
   - CloudWatch SDK v2
   - slog + CloudWatch Logs

2. OpenTelemetryアプローチ
   - OpenTelemetry Go SDK
   - AWS Distro for OpenTelemetry (ADOT)
   - X-Ray Exporter

## 1.2. 改善版実装フェーズの概要

### 1.2.1. フェーズ1: 基盤構築と基本機能実装（3週間）

1. [**週1: プロジェクト基盤とログ実装**](./implementation-plan-week1.md)
   - 開発環境のセットアップ（Docker Compose、Go/Echo、Next.js/TypeScript/TailwindCSS）
   - **Terraformの基本セットアップ（LocalStack用）**
   - **LocalStack環境用の基本的なTerraformモジュール作成（CloudWatch Logs用）**
   - **AWS CLIのセットアップと設定**
   - バックエンドの基本構造実装（プロジェクト構成、AIRによるホットリロード）
   - モックデータを使用したAPIエンドポイント実装
   - **オブザーバビリティ実装:**
     - **O-LOG-01**: slogを使用した構造化ログの基本設定（JSON形式）
     - **O-LOG-02**: ログレベル管理（ERROR/WARN/INFO/DEBUG）の適切な設定
     - **O-LOG-03**: CloudWatch Logsへのログ転送設定（LocalStackを使用した開発環境）

   **実現できるユースケース:**
   - 基本的なAPIリクエスト/レスポンスの処理
   - ヘルスチェックエンドポイント（`/api/health`）
   - モックデータを使った商品一覧取得API（`/api/products`）
   - システムログの基本的な記録と閲覧
   - LocalStackを使ったAWSリソースの簡易エミュレーション

2. [**週2: データモデルとメトリクス**](./implementation-plan-week2.md)
   - データベーススキーマ設計と実装（MySQL）
   - golang-migrateによるマイグレーション管理
   - OpenAPI仕様の初期定義と商品カタログ関連APIの定義・ogenによるコード生成
   - sqlboilerによるモデル生成とSVC-01（商品カタログサービス）の読み取り操作実装
   - シンプルな商品一覧フロントエンド画面（C-02）の作成
   - **Terraformモジュール拡張（LocalStack用CloudWatch Metrics設定）**
   - **オブザーバビリティ実装:**
     - **O-METRIC-01**: 基本メトリクス収集（リクエスト数、レイテンシー、エラー率）
     - **O-METRIC-02**: インフラメトリクス収集の設定

   **実現できるユースケース:**
   - **CUS-01**: 実データを使った商品カタログの閲覧（データベース連携）
   - 商品カテゴリの一覧表示
   - シンプルな商品一覧ページでの閲覧
   - 商品情報のデータベースからの読み取り操作
   - 基本メトリクスの収集とLocalStackでの可視化

3. [**週3: 基本機能拡張とトレース導入**](./implementation-plan-week3.md)
   - SVC-02（在庫管理サービス）の実装
   - OpenAPI仕様に在庫管理APIを追加しogenでコード生成
   - C-03（商品詳細画面）の実装
   - C-BROWSE-07（在庫状況表示）の実装
   - **Terraformモジュール拡張（LocalStack用X-Ray設定）**
   - **オブザーバビリティ実装:**
     - **O-LOG-04**: コンテキスト情報付与（リクエストID、ユーザーID等）
     - **O-TRACE-01**: AWS X-Ray SDKの基本統合

   **実現できるユースケース:**
   - **CUS-02**: 商品詳細の確認（画像、説明文、価格など）
   - **CUS-04**: 商品の在庫状況の確認
   - カテゴリー別の商品一覧表示のシンプルな実装
   - リクエストの基本的なトレース情報の収集と可視化

### 1.2.2. フェーズ2: コア機能実装とオブザーバビリティ強化（6週間）

1. [**週4: トレース機能の拡張**](./implementation-plan-week4.md)
   - **O-TRACE-02**: Echo、sqlboiler統合とカスタムサブセグメント追加
   - **O-METRIC-03**: レスポンスタイム分布測定（p50, p90, p95, p99）の設定
   - CloudWatch Logs Insightsのクエリ作成
   - ビジネスメトリクス収集の実装
   - CloudWatch Custom Metricsへのメトリクス送信設定
   - **Terraformモジュール拡張（LocalStack用CloudWatch Dashboards設定）**

   **実現できるユースケース:**
   - API呼び出し間のトレース情報の収集と可視化
   - サービス間依存関係の可視化（商品カタログ→在庫サービス）
   - システムパフォーマンスの基本的なモニタリング
   - **O-DASH-03**: RED（Rate, Error, Duration）ダッシュボードの作成

2. [**週5: カート機能の基礎実装**](./implementation-plan-week5.md)
   - データベースモデル拡張（cartsテーブル、cart_itemsテーブル）
   - OpenAPI仕様にカート管理APIを追加しogenでコード生成
   - SVC-03（カート管理サービス）の実装
   - C-04（カート画面）の基本実装
   - **オブザーバビリティ実装:**
     - **O-TRACE-03**: トレースフィルタリングの設定
     - **O-DASH-01**: AWS X-Rayダッシュボードのカスタマイズ

   **実現できるユースケース:**
   - **CUS-05**: カートへの商品追加（単一商品、数量指定）
   - **CUS-06**: カートの商品管理（追加・削除）
   - 複雑なトランザクションフローのトレース（商品選択→カート追加）

3. [**週6: カート機能の拡張**](./implementation-plan-week6.md)
   - C-04（カート画面）の機能拡張（複数商品管理、数量変更）
   - **オブザーバビリティ実装:**
     - **O-ALERT-01**: ヘルスチェックエンドポイント（SVC-06）の実装
     - **O-METRIC-06**: ビジネスメトリクスの拡張
     - **O-ALERT-02**: 基本アラート設定（エラー率やレイテンシーの異常検出）
   - **Terraformモジュール拡張（LocalStack用アラート設定）**

   **実現できるユースケース:**
   - カート内の複数商品管理（追加・削除・数量変更）
   - エラー率やレイテンシーの閾値超過時のアラート

4. **週7: 注文処理システムの基本実装**
   - データベースモデル拡張（ordersテーブル、order_itemsテーブル）
   - OpenAPI仕様に注文処理APIを追加しogenでコード生成
   - SVC-04（注文処理サービス）の基本実装
   - C-05（注文手続き画面）の基本実装
   - **オブザーバビリティ実装:**
     - **O-DASH-02**: サービスマップの強化
     - **O-CORR-01**: ログ、メトリクス、トレースの相関付け

   **実現できるユースケース:**
   - **CUS-07**: 注文手続き（配送先情報入力、注文内容確認）の基本フロー

5. **週8: 注文処理システムの拡張**
   - SVC-04（注文処理サービス）の機能拡張
   - C-06（注文完了画面）の実装
   - **オブザーバビリティ実装:**
     - **O-METRIC-07**: SVC-07（メトリクスサービス）の実装
     - **O-METRIC-08**: フロントエンドのユーザー体験メトリクス計測

   **実現できるユースケース:**
   - **CUS-08**: 注文完了と注文番号発行
   - 完全な注文フローのエンドツーエンド実装と監視

6. **週9: 管理機能の基本実装**
   - OpenAPI仕様に管理者向けAPIと認証APIを追加しogenでコード生成
   - SVC-05（認証サービス）の実装
   - A-01（管理者ログイン画面）の実装
   - A-02（管理者ダッシュボード）の基本実装
   - **オブザーバビリティ実装:**
     - **O-DASH-04**: カスタムダッシュボードの作成
     - **O-METRIC-09**: フロントエンドパフォーマンスの監視設定

   **実現できるユースケース:**
   - 管理者認証（JWTトークンベース）
   - 基本的な管理画面のレイアウトと機能

### 1.2.3. フェーズ3: 管理機能と初期デプロイ（4週間）

1. **週10: 商品管理機能**
   - A-03（商品管理画面）の実装（A-PROD-01、ADM-01）
   - A-04（商品登録画面）の実装（A-PROD-02、ADM-02）
   - **オブザーバビリティ実装:**
     - **O-TRACE-04**: 管理操作のカスタムトレース設定
     - **O-METRIC-10**: 管理アクションのメトリクス記録

   **実現できるユースケース:**
   - **ADM-01**: 商品情報の管理（一覧表示、検索、編集、削除）
   - **ADM-02**: 新規商品の登録（基本情報入力）

2. **週11: 在庫管理機能**
   - A-05（在庫管理画面）の実装（A-INV-01、A-INV-03、ADM-03、ADM-04）
   - 画像アップロード機能の追加と関連APIの実装
   - **オブザーバビリティ実装:**
     - **O-METRIC-11**: リソース使用状況のモニタリング設定
     - **O-TRACE-05**: アップロード処理の進捗トラッキング

   **実現できるユースケース:**
   - **ADM-03**: 在庫状況の監視（在庫レベルの可視化）
   - **ADM-04**: 在庫数の更新（入荷登録、在庫調整）
   - 商品画像アップロード機能

3. **週12-13: サーバーレス機能とデプロイ準備**
   - 基本的なLambda機能の実装（LocalStackを使用）
     - 画像処理Lambda（サムネイル生成）
     - イベント駆動型の在庫通知機能
   - **Terraformによる本番環境向け基本インフラ定義の拡張**
     - 開発環境用のTerraformモジュールを本番環境向けに拡張
     - ECS/Fargateの基本設定
     - RDS (MySQL)の基本設定
     - S3 + CloudFrontの基本設定
   - **オブザーバビリティ実装:**
     - Lambda機能のオブザーバビリティ設定
       - **O-LAMBDA-01**: Lambda実行ログの構造化
       - **O-LAMBDA-02**: Lambda固有のメトリクス収集
     - **O-INFRA-01**: インフラ定義にオブザーバビリティコンポーネントを組み込み

   **実現できるユースケース:**
   - アップロード画像の自動処理（サムネイル生成）
   - 在庫変動イベントの通知
   - 基本インフラのコード化

### 1.2.4. フェーズ4: AWS環境へのデプロイとOpenTelemetry実装（3週間）

1. **週14: AWS環境へのデプロイ**
   - Terraformによる本番環境構築の完了
     - ALBの設定とルーティング
     - Lambda関数のインフラ定義
     - IAM権限設定
   - CI/CDパイプラインのセットアップ（GitHub Actions）
   - **オブザーバビリティ実装:**
     - **O-LOG-06**: 本番環境でのCloudWatch Logsの設定
     - **O-TRACE-06**: 本番環境でのX-Ray設定
     - **O-ALERT-03**: アラートとSNS通知の設定

   **実現できるユースケース:**
   - 開発環境から本番環境への自動デプロイ
   - 本番環境のオブザーバビリティ（ログ・メトリクス・トレース）設定
   - リアルタイムアラートとイベント通知

2. **週15-16: OpenTelemetry実装と高度な機能**
   - AWS Distro for OpenTelemetry (ADOT) Collectorのセットアップ
   - OpenTelemetry Go SDKの実装
     - トレース実装
     - メトリクス実装
     - コンテキスト伝播の実装
   - X-Ray Exporterの設定
   - 追加Lambda機能の実装:
     - 注文確認メール送信Lambda
     - 在庫レポート生成バッチ処理Lambda
   - **オブザーバビリティ実装:**
     - **O-RUM-01**: CloudWatch RUMの設定
     - **O-SYNTH-01**: CloudWatch Syntheticsの基本設定
     - **O-COMP-01**: AWS SDK v2とOpenTelemetryの詳細比較
     - **O-COST-01**: コスト最適化の実施

   **実現できるユースケース:**
   - AWS SDK v2からOpenTelemetryへの並行実装による比較
   - ベンダー中立なオブザーバビリティデータの収集
   - 注文完了時の自動メール送信
   - 管理者向け定期在庫レポートの自動生成
   - 顧客体験の実データ（RUM）による監視

### 1.2.5. フェーズ5: 最適化と障害対応（2週間）

1. **週17-18: 最適化と障害対応シナリオ**
   - パフォーマンス最適化の実装
   - エラーハンドリングの強化
   - 耐障害性の向上
     - リトライメカニズム
     - サーキットブレーカー
     - フォールバック戦略
   - **オブザーバビリティ実装:**
     - **O-FAULT-01**: AWS Fault Injection Serviceの基本設定
     - **O-CHAOS-01**: 基本的なカオスエンジニアリング実験の設計
     - **O-FAULT-02**: 高度な障害シナリオの準備
     - **O-ALERT-04**: 障害検出とアラートの検証

   **実現できるユースケース:**
   - 制御された障害注入による回復力テスト
   - データベース接続断の自動検出と回復
   - ネットワーク遅延シナリオでのタイムアウト処理
   - 障害発生時の自動アラートと通知

## 1.3. MVP機能の概要

### 1.3.1. 顧客向け機能

- **商品閲覧機能**
  - C-BROWSE-01: ホーム画面表示 (CUS-01)
  - C-BROWSE-02: 商品一覧表示 (CUS-02)
  - C-BROWSE-03: カテゴリー別商品表示 (CUS-03)
  - C-BROWSE-07: 在庫状況表示 (CUS-04)

- **ショッピング機能**
  - C-SHOP-01: カートへの商品追加/削除 (CUS-05, CUS-06)
  - C-SHOP-02: 注文手続き/完了 (CUS-07, CUS-08)

### 1.3.2. 管理者向け機能

- **商品管理機能**
  - A-PROD-01: 商品一覧表示/編集/削除 (ADM-01)
  - A-PROD-02: 新規商品登録 (ADM-02)

- **在庫管理機能**
  - A-INV-01: 在庫レベル監視 (ADM-03)
  - A-INV-03: 在庫更新 (ADM-04)

### 1.3.3. オブザーバビリティ機能

- **ログ機能**
  - O-LOG-01: 構造化ログ設定
  - O-LOG-02: ログレベル管理
  - O-LOG-03: CloudWatch Logsへのログ転送設定
  - O-LOG-04: コンテキスト情報付与
  - O-LOG-05: CloudWatch Logs Insightsのクエリ作成
  - O-LOG-06: 本番環境でのCloudWatch Logs設定

- **メトリクス機能**
  - O-METRIC-01: 基本メトリクス収集
  - O-METRIC-02: インフラメトリクス収集
  - O-METRIC-03: レスポンスタイム分布測定
  - O-METRIC-04: ビジネスメトリクス収集
  - O-METRIC-05: CloudWatch Custom Metricsへのメトリクス送信
  - O-METRIC-06: ビジネスメトリクスの拡張
  - O-METRIC-07: メトリクスサービスの実装
  - O-METRIC-08: フロントエンドのユーザー体験メトリクス
  - O-METRIC-09: フロントエンドパフォーマンスの監視
  - O-METRIC-10: 管理アクションのメトリクス記録
  - O-METRIC-11: リソース使用状況のモニタリング

- **トレース機能**
  - O-TRACE-01: X-Ray基本統合
  - O-TRACE-02: Echo/sqlboiler統合
  - O-TRACE-03: トレースフィルタリング
  - O-TRACE-04: 管理操作のカスタムトレース
  - O-TRACE-05: アップロード処理の進捗トラッキング
  - O-TRACE-06: 本番環境でのX-Ray設定

- **アラート・可視化機能**
  - O-ALERT-01: ヘルスチェックエンドポイント
  - O-ALERT-02: 基本アラート設定
  - O-ALERT-03: アラートとSNS通知
  - O-ALERT-04: 障害検出とアラート検証
  - O-DASH-01: X-Rayダッシュボードカスタマイズ
  - O-DASH-02: サービスマップ強化
  - O-DASH-03: RED（Rate, Error, Duration）ダッシュボード
  - O-DASH-04: カスタムダッシュボード

- **相関・連携機能**
  - O-CORR-01: ログ、メトリクス、トレースの相関付け

- **Lambda固有機能**
  - O-LAMBDA-01: Lambda実行ログの構造化
  - O-LAMBDA-02: Lambda固有のメトリクス収集

- **インフラストラクチャ機能**
  - O-INFRA-01: インフラ定義のオブザーバビリティ組み込み

- **RUMと合成監視**
  - O-RUM-01: CloudWatch RUMの設定
  - O-SYNTH-01: CloudWatch Syntheticsの設定

- **耐障害性とカオスエンジニアリング**
  - O-FAULT-01: Fault Injection Serviceの設定
  - O-FAULT-02: 高度な障害シナリオの準備
  - O-CHAOS-01: カオスエンジニアリング実験

- **比較と最適化**
  - O-COMP-01: AWS SDK v2とOpenTelemetryの比較
  - O-COST-01: オブザーバビリティのコスト最適化

## 1.4. 主な変更点とバランス調整の理由

1. **作業の細分化**: 複雑なタスク（特に注文処理システムやカート機能）を複数の週に分散し、各週のワークロードをより均等に配分しました。

2. **段階的機能実装**: 機能を「基本実装」と「拡張実装」に分割し、まず基本機能を確実に実装した後で機能を拡張する方針にしました。

3. **プロジェクト期間の延長**: 全体の期間を15週から18週に延長し、各フェーズの作業量を適切に分散させました。

4. **オブザーバビリティ実装の分散**: 複雑なオブザーバビリティ機能の実装を各週に均等に分散させ、学習曲線を緩やかにしました。

5. **現実的なAWS環境構築**: AWS環境の構築とデプロイを複数の週に分割し、インフラ構築の複雑さに対応しました。

6. **フォーカスの明確化**: 各週で実現するユースケースを具体的かつ現実的に設定し、達成感を得やすくしました。

7. **Terraformの早期導入**: 週1からTerraformを導入し、LocalStackでのAWSリソース構築を可能にし、段階的に拡張することで本番環境へのスムーズな移行を計画しました。
