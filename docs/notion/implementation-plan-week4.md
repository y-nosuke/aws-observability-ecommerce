# 週4: トレース機能の拡張

## 目標とするユースケース

| ユースケースID | ユースケース名       | 優先度 | 終了時達成目標 | 完了基準                                             |
| -------------- | -------------------- | ------ | -------------- | ---------------------------------------------------- |
| OBS-05         | 分散トレース         | 高     | 90%            | X-Rayでリクエストの処理フローが詳細に可視化される    |
| OBS-04         | 基本メトリクス収集   | 高     | 90%            | レスポンスタイム分布を含む詳細メトリクスが収集される |
| OBS-01         | 構造化ログ収集       | 高     | 95%            | CloudWatch Logs Insightsでログ分析が可能になる       |
| OBS-06         | サービスマップ可視化 | 中     | 70%            | X-Rayサービスマップでサービス間の関係が表示される    |

## 実装する機能

| 機能ID      | 機能名                         | 説明                                         | 関連ユースケース | 終了時達成目標 |
| ----------- | ------------------------------ | -------------------------------------------- | ---------------- | -------------- |
| O-TRACE-02  | Echo/sqlboiler統合             | ウェブフレームワークとORMへのトレース統合    | OBS-05           | 90%            |
| O-METRIC-03 | レスポンスタイム分布測定       | p50, p90, p95, p99パーセンタイルの計測       | OBS-04           | 90%            |
| O-LOG-05    | CloudWatch Logs Insightsクエリ | ログデータの効率的な検索と分析用クエリの作成 | OBS-01           | 95%            |
| O-METRIC-04 | ビジネスメトリクス収集         | 閲覧数、購入数など業務関連指標の収集         | OBS-04           | 80%            |
| O-METRIC-05 | CloudWatch Custom Metrics連携  | カスタムメトリクスのCloudWatchへの送信       | OBS-04           | 90%            |
| O-DASH-03   | REDダッシュボード              | Rate, Error, Duration指標のダッシュボード    | OBS-06           | 80%            |

## 実装するAPI

| API ID         | API名             | エンドポイント | メソッド | 関連機能                 | 終了時達成目標 |
| -------------- | ----------------- | -------------- | -------- | ------------------------ | -------------- |
| API-METRICS-01 | 拡張メトリクスAPI | `/api/metrics` | GET      | O-METRIC-03, O-METRIC-04 | 100%           |

## 実装する画面

この週は主にバックエンドとオブザーバビリティの機能強化が中心のため、新規画面の実装はありません。

## 詳細タスク

| タスクID | タスク名                                       | タスク種別         | 見積時間 | 依存タスク         | 関連API        | 関連画面 | 関連機能                 | 関連ユースケース |
| -------- | ---------------------------------------------- | ------------------ | -------- | ------------------ | -------------- | -------- | ------------------------ | ---------------- |
| TASK-058 | Echo Webフレームワークへのトレース統合         | オブザーバビリティ | 4h       | TASK-048           | -              | -        | O-TRACE-02               | OBS-05           |
| TASK-059 | sqlboiler ORMへのトレース統合                  | オブザーバビリティ | 4h       | TASK-052           | -              | -        | O-TRACE-02               | OBS-05           |
| TASK-060 | カスタムサブセグメント追加                     | オブザーバビリティ | 3h       | TASK-058           | -              | -        | O-TRACE-02               | OBS-05           |
| TASK-061 | レスポンスタイム分布測定の設定                 | オブザーバビリティ | 3h       | -                  | -              | -        | O-METRIC-03              | OBS-04           |
| TASK-062 | パーセンタイル計算の実装                       | オブザーバビリティ | 3h       | TASK-061           | -              | -        | O-METRIC-03              | OBS-04           |
| TASK-063 | CloudWatch Logs Insightsクエリの作成           | オブザーバビリティ | 3h       | -                  | -              | -        | O-LOG-05                 | OBS-01           |
| TASK-064 | ログクエリパターンのドキュメント化             | オブザーバビリティ | 2h       | TASK-063           | -              | -        | O-LOG-05                 | OBS-01           |
| TASK-065 | ビジネスメトリクス収集の設計                   | 設計               | 2h       | -                  | -              | -        | O-METRIC-04              | OBS-04           |
| TASK-066 | 商品閲覧メトリクスの実装                       | オブザーバビリティ | 3h       | TASK-065           | -              | -        | O-METRIC-04              | OBS-04           |
| TASK-067 | カテゴリー閲覧メトリクスの実装                 | オブザーバビリティ | 2h       | TASK-065           | -              | -        | O-METRIC-04              | OBS-04           |
| TASK-068 | CloudWatch Custom Metrics統合                  | オブザーバビリティ | 3h       | TASK-066, TASK-067 | -              | -        | O-METRIC-05              | OBS-04           |
| TASK-069 | カスタムメトリクス送信の最適化                 | オブザーバビリティ | 3h       | TASK-068           | -              | -        | O-METRIC-05              | OBS-04           |
| TASK-070 | メトリクスAPIのエンドポイント拡張              | 実装               | 3h       | TASK-062, TASK-066 | API-METRICS-01 | -        | O-METRIC-03, O-METRIC-04 | OBS-04           |
| TASK-071 | メトリクスダッシュボードの設計                 | 設計               | 2h       | -                  | -              | -        | O-DASH-03                | OBS-06           |
| TASK-072 | RED (Rate, Error, Duration) ダッシュボード作成 | オブザーバビリティ | 4h       | TASK-071           | -              | -        | O-DASH-03                | OBS-06           |
| TASK-073 | Terraformモジュール拡張（ダッシュボード設定）  | インフラ           | 3h       | TASK-072           | -              | -        | O-DASH-03                | OBS-06           |
| TASK-074 | サブセグメント単体テスト                       | テスト             | 2h       | TASK-060           | -              | -        | O-TRACE-02               | OBS-05           |
| TASK-075 | メトリクスレポート生成機能                     | 実装               | 3h       | TASK-070           | API-METRICS-01 | -        | O-METRIC-04              | OBS-04           |
| TASK-076 | サービス間依存関係のマッピング                 | オブザーバビリティ | 3h       | TASK-058, TASK-059 | -              | -        | O-TRACE-02               | OBS-06           |

## 週4の進捗追跡ダッシュボード

```
AWS オブザーバビリティ学習プロジェクト - 週4進捗ダッシュボード
----------------------------------------------------------
全体進捗: 52% [█████████████·············]

【タスク完了率】
週1〜3のタスク: 100% [████████████████████████] (57/57 完了)
週4のタスク: 100% [████████████████████████] (19/19 完了)

【API完成率】
API-METRICS-01 (拡張メトリクスAPI): 100% [████████████████████████]

【機能完成率】
O-TRACE-02 (Echo/sqlboiler統合): 90% [██████████████████████··]
O-METRIC-03 (レスポンスタイム分布測定): 90% [██████████████████████··]
O-LOG-05 (CloudWatch Logs Insightsクエリ): 95% [███████████████████████·]
O-METRIC-04 (ビジネスメトリクス収集): 80% [████████████████████····]
O-METRIC-05 (CloudWatch Custom Metrics連携): 90% [██████████████████████··]
O-DASH-03 (REDダッシュボード): 80% [████████████████████····]

【ユースケース実現率】
OBS-05 (分散トレース): 90% [██████████████████████··]
OBS-04 (基本メトリクス収集): 90% [██████████████████████··]
OBS-01 (構造化ログ収集): 95% [███████████████████████·]
OBS-06 (サービスマップ可視化): 70% [█████████████████·······]

【前週からの改善ユースケース】
OBS-05 (分散トレース): 75% → 90% [+15%]
OBS-04 (基本メトリクス収集): 80% → 90% [+10%]
OBS-01 (構造化ログ収集): 90% → 95% [+5%]

【カテゴリー別進捗】
顧客向け機能: 70% [█████████████████·······] (変化なし)
管理者向け機能: 0% [························] (変化なし)
オブザーバビリティ機能: 88% [██████████████████████··] (+8%)

【注目ポイント】
- トレースとメトリクスの連携が実現
- ビジネスメトリクスによる業務状況の可視化
- クエリによるログデータの高度な分析が可能に

【次のステップ】
1. カート機能の基礎実装（週5）
2. トレースフィルタリング設定（週5）
3. X-Rayダッシュボードのカスタマイズ（週5）
```

## Notionでの管理ポイント

1. **オブザーバビリティ連携の可視化**:
   - トレース、メトリクス、ログ間の連携状況をビジュアル化
   - 各コンポーネント間の依存関係をマインドマップで表現

2. **メトリクスデータの記録と分析**:
   - 実際に収集されたメトリクスのスナップショットを保存
   - パーセンタイル値の推移をグラフ化
   - ビジネスメトリクスとシステムメトリクスの相関分析

3. **ダッシュボードのバージョン管理**:
   - ダッシュボード設定のスナップショットを記録
   - 改善前/改善後の比較を視覚化

4. **知識ベースの構築**:
   - CloudWatch Logs Insightsクエリのレシピ集
   - X-Ray分析パターンのカタログ
   - トラブルシューティングガイド

## 週4の終了時点での成果物

1. **高度なトレース機能**:
   - Echo/sqlboilerと統合されたトレース情報
   - カスタムサブセグメントによる詳細な処理フロー
   - サービス間依存関係の可視化

2. **拡張メトリクス基盤**:
   - レスポンスタイム分布（p50, p90, p95, p99）の計測
   - ビジネスメトリクス（商品閲覧数、カテゴリー閲覧数）の収集
   - CloudWatch Custom Metricsへの送信

3. **高度なログ分析**:
   - CloudWatch Logs Insightsクエリのコレクション
   - エラーパターン検出クエリ
   - パフォーマンス分析クエリ

4. **統合ダッシュボード**:
   - REDメトリクス（Request Rate, Error Rate, Duration）ダッシュボード
   - パフォーマンス指標の視覚化
   - サービスマップの基本表示
