# Notion APIでAWSオブザーバビリティ学習プロジェクト管理を自動化する方法

このガイドでは、Notion APIを使ってAWSオブザーバビリティ学習プロジェクトのセットアップを自動化する方法を解説します。データベース作成から関係設定、初期データ入力までを一気に行うことで、プロジェクト開始時の手間を大幅に削減できます。

## 1. Notion API による自動化の概要

Notion APIを使えば以下を自動化できます：

- データベースの作成
- プロパティの設定
- リレーションの構築
- 初期データの投入

これにより、手作業で行うと数時間かかる作業を数分で完了させることが可能になります。

## 2. プロジェクト構造と機能

今回のスクリプトは、以下のようなファイル構造になっています：

```text
notion-aws-observability-setup/
├── .envrc                      # 環境変数ファイル
├── package.json                # npm設定ファイル
├── tsconfig.json               # TypeScript設定ファイル
├── src/
│   ├── setup-notion-project.ts # メインスクリプト
│   ├── create-databases.ts     # データベース作成関数
│   ├── createTaskDatabase.ts   # タスクデータベース作成関数
│   ├── data/                   # データ定義ファイル
│   │   ├── usecases.ts         # ユースケースデータ
│   │   ├── features.ts         # 機能データ
│   │   ├── apis.ts             # APIデータ
│   │   └── screens.ts          # 画面データ
│   └── utils/                  # ユーティリティ関数
│       ├── logger.ts           # ロギングユーティリティ
│       └── rate-limiter.ts     # レート制限対策ユーティリティ
└── dist/                       # コンパイル後のJavaScriptファイル
```

### 2.1. 主な機能

このスクリプトには以下の主要な機能があります：

1. **データベースの自動作成**
   - ユースケース、機能、API、画面、タスクの5つのデータベースを作成
   - 各データベースに適切なプロパティとオプションを設定

2. **データベース間のリレーション設定**
   - 5つのデータベース間の関連付けを自動設定
   - 双方向のリレーション設定（例：機能→ユースケース、ユースケース→機能）
   - タスクと他のデータベースとの連携設定

3. **初期データの投入**
   - mvp-use-cases.md、mvp-features-business.md、mvp-backend-services.md、mvp-screens.mdからの全データを抽出
   - 合計100以上のアイテムをデータベースに投入
   - タスクデータは手動で作成（自動投入なし）

4. **レート制限対策**
   - APIリクエスト間の適切な待機時間設定
   - バッチ処理によるデータ分割投入
   - エラー発生時の自動再試行メカニズム

5. **詳細なログ出力**
   - 処理状況のリアルタイム表示
   - エラー発生時の詳細情報提供

## 3. セットアップ手順

### 3.1. 前提条件

自動化スクリプトの実行には以下のものが必要です：

1. **Node.js**: v14以上（[Node.js公式サイト](https://nodejs.org/)からダウンロード）
2. **TypeScript**: v4以上（`npm install -g typescript`でインストール）
3. **direnv**: 環境変数管理用（[direnvの公式サイト](https://direnv.net/)からインストール）
4. **Notionアカウント**: 自動化対象のNotionワークスペースへのアクセス権限

### 3.2. Notion統合（インテグレーション）の作成

Notion APIを使用するには、インテグレーション（統合）を作成する必要があります。以下の手順に従ってください：

1. **Notion Developersサイトにアクセス**:
   - ブラウザで [Notion Developers](https://developers.notion.com/) を開きます
   - 右上の「Log in」または「Sign up」をクリックして、Notionアカウントでログインします

2. **新しい統合の作成**:
   - 画面上部の「View my integrations」をクリックします
   - 「+ New integration」ボタンをクリックします

3. **統合の基本情報を設定**:
   - **Name**: 「AWS オブザーバビリティ学習セットアップ」と入力します
   - **Associated workspace**: 統合を使用するワークスペースを選択します
   - **Logo**: 任意で統合のロゴを設定できます（後でも変更可能）
   - 「Submit」ボタンをクリックします

4. **機能と権限の設定**:
   - 作成した統合の詳細ページで「Capabilities」セクションを確認します
   - 必要な権限を選択します：
     - 「Content Capabilities」セクションで以下を選択します：
       - ✓ Read content（コンテンツ読み取り）
       - ✓ Update content（コンテンツ更新）
       - ✓ Insert content（コンテンツ挿入）
   - 「Save changes」ボタンをクリックします

5. **Internal Integration Token（秘密鍵）の取得**:
   - 作成した統合の詳細ページの「Secrets」セクションに「Internal Integration Token」が表示されます
   - 「Show」または「Copy」ボタンでトークンをコピーします
   - このトークンを後ほど環境変数として使用します

   > ⚠️ **重要**: このトークンは秘密情報です。公開リポジトリにアップロードしたり、他人と共有したりしないでください。

### 3.3. Notionページの準備とIDの取得

自動セットアップを適用するNotionページを準備し、そのIDを取得します：

1. **新しいNotionページの作成**:
   - Notionを開き、新しいページを作成します（または既存のページを使用）
   - 例えば「AWS オブザーバビリティ学習プロジェクト」というタイトルのページを作成します

2. **統合をページに招待**:
   - ページ右上の「...」（設定メニュー）をクリックします
   - 「Add connections」を選択します
   - 先ほど作成した「AWS オブザーバビリティ学習セットアップ」統合を検索して選択します

3. **ページIDの取得**:
   - ブラウザでそのページを開いている状態で、URLをチェックします
   - URLの形式は通常、以下のいずれかになります：
     - `https://www.notion.so/ワークスペース名/ページID?v=...`
     - `https://www.notion.so/ページタイトル-ページID`
   - 後者の形式の例：`https://www.notion.so/AWS-1b5ae90b4c058074acb2d716e8f21348`
   - 上記の例では、「AWS-」の後の部分 `1b5ae90b4c058074acb2d716e8f21348` がページIDです

   > 📝 **注意**: ページIDは常に32文字の英数字です。URLにハイフンやダッシュが含まれていても、Notion APIで使用するページIDにはハイフンを含めないでください。

### 3.4. プロジェクトのセットアップ

ここでは、プロジェクトを最初から作成する手順を説明します。

1. **プロジェクトディレクトリの作成**:

   ```bash
   mkdir notion-setup
   cd notion-setup
   ```

2. **npmプロジェクトの初期化**:

   ```bash
   npm init -y
   ```

3. **TypeScriptプロジェクトの初期化**:

   ```bash
   npm install -D typescript @types/node ts-node
   npx tsc --init
   ```

4. **必要な依存関係のインストール**:

   ```bash
   # メイン依存関係
   npm install @notionhq/client

   # 開発用の依存関係
   npm install -D @typescript-eslint/eslint-plugin @typescript-eslint/parser eslint
   ```

5. **プロジェクト構造の作成**:

   ```bash
   # ソースコードとデータディレクトリの作成
   mkdir -p src/utils src/data

   # distディレクトリ（コンパイル先）の作成
   mkdir dist
   ```

6. **環境変数ファイルの作成**:

   ```bash
   touch .envrc
   ```

   `.envrc`ファイルに以下の内容を追加します：

   ```bash
   # Notion APIキー (必須)
   export NOTION_API_KEY=your_integration_token_here

   # Notionの親ページID (必須)
   export NOTION_PARENT_PAGE_ID=your_page_id_here

   # デバッグモード（任意）
   # export DEBUG=1
   ```

7. **設定ファイルの編集**:

   **tsconfig.json**の内容を以下のように更新：

   ```json
   {
     "compilerOptions": {
       "target": "ES2020",
       "module": "commonjs",
       "lib": ["ES2020"],
       "outDir": "./dist",
       "rootDir": "./src",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "forceConsistentCasingInFileNames": true,
       "resolveJsonModule": true,
       "declaration": true,
       "sourceMap": true
     },
     "include": ["src/**/*"],
     "exclude": ["node_modules", "dist"]
   }
   ```

   **package.json**の`scripts`セクションを更新：

   ```json
   "scripts": {
     "build": "tsc",
     "start": "node dist/setup-notion-project.js",
     "dev": "ts-node src/setup-notion-project.ts",
     "lint": "eslint src/**/*.ts",
     "lint:fix": "eslint src/**/*.ts --fix"
   }
   ```

8. **ソースファイルの作成**:

   各TypeScriptファイルを`src`ディレクトリに作成します。ガイドの他のセクションで提供されたコードをそれぞれのファイルにコピーしてください。

   - `src/types.ts`: 共通型定義
   - `src/utils/logger.ts`: ロギングユーティリティ
   - `src/utils/rate-limiter.ts`: APIレート制限ユーティリティ
   - `src/create-databases.ts`: データベース作成関数
   - `src/createTaskDatabase.ts`: タスクデータベース作成関数
   - `src/data/usecases.ts`: ユースケースデータ
   - `src/data/features.ts`: 機能データ
   - `src/data/apis.ts`: APIデータ
   - `src/data/screens.ts`: 画面データ
   - `src/setup-notion-project.ts`: メインスクリプト

9. **環境変数を有効化**:

   ```bash
   direnv allow .
   ```

   > 📝 **注意**: `direnv`を使用しない場合は、ターミナルで直接環境変数を設定することもできます。
>
   > ```bash
   > export NOTION_API_KEY=your_integration_token_here
   > export NOTION_PARENT_PAGE_ID=your_page_id_here
   > ```

10. **TypeScriptのコンパイル**:

    ```bash
    npm run build
    ```

## 4. スクリプトの実行

前述の準備が完了した後、以下のコマンドでスクリプトを実行します：

```bash
npm start
```

または、コンパイル済みのJavaScriptを直接実行することもできます：

```bash
node dist/setup-notion-project.js
```

実行すると、以下のプロセスが行われます：

1. 5つのデータベース（ユースケース、機能、API、画面、タスク）が作成されます
2. データベース間のリレーションが設定されます
3. 初期データが各データベースに投入されます（タスクデータベースを除く）
4. コンソールに処理状況とエラー（もしあれば）が表示されます

実行例：

```bash
[INFO] AWS オブザーバビリティ学習プロジェクトのセットアップを開始します...
[INFO] ステップ1: データベースの作成
[INFO] ユースケースデータベースを作成しています...
[INFO] ユースケースデータベースを作成するためのAPIリクエストを実行します
[DEBUG] ユースケースデータベース作成が成功しました: 1b2c3d4e5f67890abcdef1234567890
[SUCCESS] ユースケースDB作成完了: 1b2c3d4e5f67890abcdef1234567890
[INFO] 機能データベースを作成しています...
...
[INFO] タスクデータベースを作成しています...
[INFO] タスクデータベースを作成するためのAPIリクエストを実行します
[DEBUG] タスクデータベース作成が成功しました: 5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u
[SUCCESS] タスクDB作成完了: 5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u
...
[INFO] データベース間の関連を更新しています...
[DEBUG] ユースケースDBに関連プロパティを追加しました
[DEBUG] 機能DBに関連プロパティを追加しました
...
[DEBUG] タスクDBに関連プロパティを追加しました
...
[INFO] ステップ2: 初期データの投入
[INFO] ユースケースデータを準備しています...
[INFO] ユースケースデータ: 22件
[INFO] ユースケースデータを投入しています...
[INFO] 22件のデータを挿入します（バッチサイズ: 10）
[INFO] バッチ処理: 1～10/22
...
[SUCCESS] ユースケースデータ投入完了: 22件
...
[INFO] AWS オブザーバビリティ学習プロジェクトのセットアップが完了しました！
[INFO] データベースID一覧:
{
  "usecases": "1b2c3d4e5f67890abcdef1234567890",
  "features": "2c3d4e5f67890abcdef123456789012",
  "apis": "3d4e5f67890abcdef1234567890123",
  "screens": "4e5f67890abcdef12345678901234",
  "tasks": "5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u"
}
[INFO] スクリプトの実行が完了しました。
```

実行時間は、データ量とNotion APIのレスポンス時間によって変わりますが、通常は3〜5分程度です。

## 5. 実行結果の確認

スクリプトが正常に実行されたら、以下を確認します：

1. Notionページにアクセスし、データベースが正しく作成されていることを確認
   - ユースケース、機能、API、画面、タスクの5つのデータベースが表示されていることを確認

2. 各データベースに正しく初期データが入力されていることを確認
   - ユースケースデータベース: 顧客向け、管理者向け、オブザーバビリティに関するユースケース
   - 機能データベース: MVP機能と拡張機能
   - APIデータベース: エンドポイント一覧
   - 画面データベース: 顧客向けと管理者向けの画面
   - タスクデータベース: まだデータが投入されていない空の状態

3. データベース間のリレーション（関連性）が正しく設定されていることを確認
   - 機能データベースからユースケースデータベースへのリレーション
   - APIデータベースから機能データベースへのリレーション
   - 画面データベースから機能データベースへのリレーション
   - タスクデータベースと他のすべてのデータベースとのリレーション

## 6. カスタマイズ方法

スクリプトは基本的な設定で実行されますが、必要に応じて以下のようにカスタマイズすることができます：

### 6.1. データの追加や変更

1. **データファイルの編集**:
   各データタイプのデータファイルを編集して、データを追加・変更・削除できます。
   - `src/data/usecases.ts`
   - `src/data/features.ts`
   - `src/data/apis.ts`
   - `src/data/screens.ts`

2. **データベース構造の変更**:
   `src/create-databases.ts`や`src/createTaskDatabase.ts`内の各データベース作成関数を編集して、プロパティやオプションを変更できます。

### 6.2. バッチサイズの調整

Notion APIのレート制限に対応するため、データは小さなバッチに分けて投入されます。バッチサイズを変更する場合は、`src/setup-notion-project.ts`内の以下の値を調整します：

```typescript
// バッチサイズの設定（一度に処理するアイテム数）
const BATCH_SIZE = 10;
```

レート制限エラーが発生する場合は、この値を小さくしてください。

### 6.3. ログレベルの調整

より詳細なログを出力したい場合は、環境変数`DEBUG`を設定します：

```bash
DEBUG=1 npm start
```

これにより、デバッグレベルのログメッセージも出力されます。

### 6.4. タスクデータの作成と連携

タスクデータベースは自動的に作成されますが、初期データは投入されません。以下のステップでタスクを作成し、他のデータベースと連携させることができます：

1. **タスクの手動作成**:
   - タスクデータベースにアクセスし、「＋」ボタンをクリックして新しいタスクを作成
   - タスク名、内容、優先度、カテゴリなどの基本情報を入力
   - 状態プロパティで作業状況を「未着手」「進行中」「完了」などから選択

2. **他のデータベースとの関連付け**:
   - 作成したタスクの「関連ユースケース」「関連機能」「関連API」「関連画面」プロパティで、関連するアイテムを選択
   - 例えば、「基本的な商品閲覧」ユースケースに関連するタスクであれば、「関連ユースケース」プロパティで該当するユースケースを選択

3. **タスクのプロジェクト管理**:
   - タスクのステータスを更新することで、プロジェクトの進捗を管理
   - 「期限」プロパティを設定してスケジュール管理
   - 「担当者」プロパティで担当者を割り当て

## 7. トラブルシューティング

スクリプト実行中に問題が発生した場合は、以下の点を確認してください：

### 7.1. 認証エラー

```bash
[ERROR] セットアップ中にエラーが発生しました: Could not authenticate with the provided token.
```

この場合：

- `.envrc`に正しいAPIキーが設定されているか確認
- `direnv allow .`が実行されているか確認
- APIキーが有効かNotionの統合ページで確認

### 7.2. アクセス権限エラー

```bash
[ERROR] セットアップ中にエラーが発生しました: Could not find page with ID: xxx
```

この場合：

- 正しいページIDが設定されているか確認
- 統合がそのページに招待されているか確認

### 7.3. レート制限エラー

```bash
[WARN] レート制限に達しました。60秒間待機します...
```

この場合：

- これは通常の動作です。スクリプトは自動的に待機して再試行します
- 頻繁に発生する場合は、バッチサイズを小さくしてみてください

### 7.4. コンパイルエラー

```bash
error TS2322: Type '...' is not assignable to type '...'.
```

この場合：

- TypeScriptの型定義に問題があります
- エラーメッセージに従って該当箇所を修正してください

### 7.5. その他のエラー

その他のエラーが発生した場合は、エラーメッセージを確認して対応してください。一時的な問題であれば、数分待ってから再実行することで解決する場合もあります。

## 8. さらなるカスタマイズ

スクリプトはプロジェクト管理の基本構造をセットアップしますが、さらに以下のようなカスタマイズが可能です：

### 8.1. ビューの設定

Notion APIではビューの詳細設定に制限があるため、データベースの基本ビューを手動で設定することをおすすめします：

1. **ユースケースデータベース**:
   - カンバンビュー（カテゴリ別）
   - リスト/ギャラリービュー（優先度別）

2. **機能データベース**:
   - カンバンビュー（カテゴリ別）
   - カレンダービュー（実装予定日別）

3. **APIデータベース**:
   - リストビュー（サービスID別）
   - ギャラリービュー（メソッド別）

4. **画面データベース**:
   - ギャラリービュー（タイプ別）
   - リストビュー（優先度別）

5. **タスクデータベース**:
   - カンバンビュー（状態別）
   - カレンダービュー（期限別）
   - リストビュー（優先度別）
   - ギャラリービュー（カテゴリ別）

### 8.2. 進捗管理の拡張

1. **数式プロパティの追加**:
   - タスクの完了状況を集計する数式
   - 機能やユースケースの進捗を可視化する数式

2. **リレーションベースのロールアップ**:
   - 関連するタスクの進捗状況をロールアップするプロパティ
   - 依存関係のあるアイテム間の進捗同期

3. **ダッシュボードの追加**:
   - プロジェクト全体の進捗を表示するダッシュボードページ
   - 主要指標のリアルタイム表示

### 8.3. タスク管理機能の強化

1. **ガントチャート**:
   - タスクの依存関係と期間を視覚化するガントチャートビュー
   - タイムラインでの進捗確認

2. **タスクのグループ化**:
   - フェーズやスプリントでタスクをグループ化
   - 同じカテゴリや優先度のタスクをまとめて表示

3. **タスク進捗の自動計算**:
   - サブタスクの完了に基づく親タスクの進捗自動更新
   - 時間ベースのバーンダウンチャート

4. **タスク割り当て通知**:
   - 新規タスク割り当て時の自動通知
   - 期限が近づいたタスクのリマインダー

これらの設定を活用することで、AWSオブザーバビリティ学習プロジェクトをより効率的に管理できるようになります。

## 9. 定期的なメンテナンス

プロジェクトの進行に合わせて、以下のようなメンテナンスを行うことをおすすめします：

1. **新しいアイテムの追加**:
   - 新たに発見されたユースケースや機能の追加
   - 実装が進むにつれて詳細化されるAPIや画面の情報更新
   - プロジェクトの進行に合わせた新しいタスクの作成

2. **進捗状況の更新**:
   - 実装が完了したアイテムの進捗を100%に更新
   - 問題や障害が発生したアイテムにコメントを追加
   - タスクのステータスを定期的に更新

3. **リレーションの更新**:
   - 新しいアイテム間の関連付け
   - 既存のリレーションの見直しと更新
   - タスクと他のデータベースアイテムの関連付け

4. **定期的なバックアップ**:
   - 重要なデータの定期的なエクスポート
   - プロジェクト構造の変更前のスナップショット作成

## 10. タスク管理ベストプラクティス

タスクデータベースを効果的に活用するためのベストプラクティス：

1. **タスクの粒度**:
   - 1つのタスクは1-2日で完了できる大きさが理想的
   - 大きすぎるタスクは細分化する
   - 小さすぎるタスクはグループ化する

2. **状態管理の一貫性**:
   - 全チームメンバーで状態の定義を統一する
   - 状態更新のルールを明確にする
   - 定期的にステータスを更新する習慣をつける

3. **優先度の明確化**:
   - 複数の基準（緊急性、重要性、依存関係）を考慮して優先度を決定
   - 優先度の高いタスクは視覚的に目立たせる
   - 優先度は状況変化に応じて柔軟に変更

4. **効果的なタスク記述**:
   - タスク名は具体的な動詞で始める
   - 内容には達成条件を明確に記述
   - 技術的な詳細や参考資料へのリンクを含める

5. **関連性の適切な設定**:
   - タスクと関連する他のデータベースアイテムを必ず関連付ける
   - 1つのタスクが複数の機能やユースケースに関連する場合はすべて設定
   - 関連するタスク同士も関連付けを設定

これらのプラクティスと設定を活用することで、AWSオブザーバビリティ学習をより体系的かつ効率的に進めることができます。タスクデータベースの追加により、学習計画の立案から進捗管理、成果の評価まで一貫したプロジェクト管理が可能になります。
